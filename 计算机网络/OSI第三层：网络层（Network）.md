# OSI第三层：网络层（Network）

## 网络层的功能
* 在网络中传输数据。
* 采用分级寻址。
* 将网络分段，并且控制流量。
* 减少网络拥堵。
* 与其他网段通信。

## IP地址
* 32位二进制数字，由网段号和主机号组成。
* 5类地址：

| 类别 | 格式 | 号段 | 私有地址空间 |
| --- | --- | --- | --- |
| A类地址 | 0+7位网络号+24位主机号 | 0～127 | 10.0.0.0～10.255.255.255 |
| B类地址 | 10+14位网络号+16位主机号 | 128～191 | 172.16.0.0～172.31.255.255 |
| C类地址 | 110+21位网络号+8位主机号 | 192～223 | 192.168.0.0～192.168.255.255 |
| D类地址 | 1110+20位网络号+8位主机号 | 224～239 | 无 |
| E类地址 | 1111+20位网络号+8位主机号 | 240～255 | 无 |
> 其中，D类地址用于多播，E类地址用于研究。
> 网段号是指主机号全为0，广播地址是主机号全为1。

## 子网和子网掩码
* 子网是指从主机号段借位来继续划分网段，可借位数最小为2，最大为主机号位数-2。
* 子网掩码用来决定网段号和主机号分别为多少位，与IP地址做按位AND运算。
    * A类地址：255.0.0.0
    * B类地址：255.255.0.0
    * C类地址：255.255.255.0

## 交换机和路由器的区别

### 二层交换机
* 二层交换机是数据链路层的设备，它能够读取数据包中的MAC地址信息并根据MAC地址来进行交换。交换机内部有一个地址表，这个地址表标明了MAC地址和交换机端口的对应关系。
* 当交换机从某个端口收到一个数据包，它首先读取包头中的源MAC地址，这样它就知道源MAC地址的机器是连在哪个端口上的，它再去读取包头中的目的MAC地址，并在地址表中查找相应的端口，如果表中有与这目的MAC地址对应的端口，则把数据包直接复制到这端口上，如果在表中找不到相应的端口则把数据包广播到所有端口上，当目的机器对源机器回应时，交换机又可以学习一目的MAC地址与哪个端口对应，在下次传送数据时就不再需要对所有端口进行广播了。
* 二层交换机一般都含有专门用于处理数据包转发的ASIC （Application Specific Integrated Circuit）芯片，因此转发速度可以做到非常快。

### 路由器
* 路由器是网络层的设备，它内部有一个路由表，标明了如果要去某个地方，下一步应该往哪走。
* 路由器从某个端口收到一个数据包，它首先把链路层的包头去掉（拆包），读取目的IP地址，然后查找路由表，若能确定下一步往哪送，则再加上链路层的包头（打包），把该数据包转发出去；如果不能确定下一步的地址，则向源地址返回一个信息，并把这个数据包丢掉。
* 路由技术其实是由两项最基本的活动组成，即决定最优路径和传输数据包。其中，数据包的传输相对较为简单和直接，而路由的确定则更加复杂一些。路由算法在路由表中写入各种不同的信息，路由器会根据数据包所要到达的目的地选择最佳路径把数据包发送到可以到达该目的地的下一台路由器处。当下一台路由器接收到该数据包时，也会查看其目标地址，并使用合适的路径继续传送给后面的路由器。依次类推，直到数据包到达最终目的地。
* 路由器之间可以进行相互通讯，而且可以通过传送不同类型的信息维护各自的路由表。路由更新信息主是这样一种信息，一般是由部分或全部路由表组成。通过分析其它路由器发出的路由更新信息，路由器可以掌握整个网络的拓扑结构。链路状态广播是另外一种在路由器之间传递的信息，它可以把信息发送方的链路状态及进的通知给其它路由器。

### 三层交换机
* 三层交换机是带有路由功能的二层交换机，它是二者的有机结合，并不是简单的把路由器设备的硬件及软件简单地叠加在二层交换机上。
* 从硬件上看，第二层交换机的接口模块都是通过高速背板/总线交换数据的；在第三层交换机中，与路由器有关的第三层路由硬件模块也插接在高速背板/总线上，这种方式使得路由模块可以与需要路由的其他模块间高速的交换数据，从而突破了传统的外接路由器接口速率的限制。
* 在软件方面，第三层交换机也有重大的举措，它将传统的基于软件的路由器软件进行了界定，其做法是：对于数据包的转发，如IP/IPX包的转发，这些规律的过程通过硬件得以高速实现。其他软件功能如路由信息的更新、路由表维护、路由计算、路由的确定等，用优化、高效的软件实现。

## 地址解析协议ARP

### ARP概述
地址解析协议ARP（Address Resolution Protocol）是网络层的协议，它根据IP数据包头中的IP地址信息解析出目标MAC地址。

### ARP缓存
ARP缓存是个用来储存IP地址和MAC地址的缓冲区，其本质就是一个IP地址和MAC地址的对应表，表中每一个条目分别记录了网络上其他主机的IP地址和对应的MAC地址。

### 例子
1. 主机A根据自己的路由表内容，确定主机B的IP地址，然后在本地ARP缓存中检查主机B的匹配MAC地址。
2. 如果主机A在ARP缓存中没有找到映射，就将查找主机B的IP地址的ARP请求帧广播到本地网络上的所有主机。源主机A的IP地址和MAC地址都包括在ARP请求中。
3. 本地网络上的每台主机都接收到ARP请求并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。而主机B接收到ARP请求后确定其中的IP地址与自己的IP地址匹配，就将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。
4. 主机B将包含其MAC地址的ARP回复消息直接发送回主机A。
5. 当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP和MAC地址映射更新ARP缓存。本机缓存是有生存期的，生存期结束后，将再次重复上面的过程。主机B的MAC地址一旦确定，主机A就能向主机B发送IP通信了。

