# MySQL
一种开源的关系型数据库，使用SQL进行数据库管理。

## MySQL的存储引擎：MyISAM和InnoDB
MyISAM由早期的ISAM（Indexed Sequential Access Method，有索引的顺序访问方法）改良，虽然性能极佳，但它有一个显著的缺点：不支持事务处理，因此MySQL引入了另一种引擎：InnoDB，它可以支持ACID兼容的事务功能，可以强化参考完整性与并发违规处理机制，后来就逐渐取代MyISAM。

### 存储结构
* MyISAM：每个表在磁盘上存储成三个文件，分别存储表定义、数据文件和索引文件。
* InnoDB：所有的表都保存在同一个数据文件中，也可能是多个文件，或者是独立的表空间文件，InnoDB表的大小只受限于操作系统文件的大小，一般为2GB。

### 存储空间
* MyISAM：可被压缩，占据的存储空间较小，支持静态表、动态表、压缩表三种不同的存储格式。
* InnoDB：需要更多的内存和存储，它会在主内存中建立其专用的缓冲池用于高速缓冲数据和索引。

### 可移植性：备份及恢复
* MyISAM：数据以文件的形式存储，所以数据转移很方便，在备份和恢复时也可单独对某个表进行操作。
* InnoDB：用`mysqldump`命令备份，在数据量大时相对麻烦。

### 事务支持
* MyISAM：强调性能，每次查询具有原子性，其执行速度比InnoDB类型更快，但是不提供事务支持。
* InnoDB：提供事务、外键等高级数据库功能，具有事务提交、回滚和崩溃修复能力，支持四种隔离级别。

### 锁机制
* MyISAM：只支持表级锁，用户在操作MyISAM表时，`SELECT`、`UPDATE`、`DELETE`和`INSERT`语句都会给表自动加锁。
    * 表共享读锁：不会阻塞其他用户对同一表的读操作，但会阻塞写操作。
    * 表独占写锁：会阻塞其他用户对同一表的读和写操作。
* InnoDB：支持事务和行级锁，可以大幅提高并发性能，但是InnoDB的行锁只对WHERE子句中的主键有效，非主键的WHERE会锁全表。
    * 行共享锁：允许一个事务去读一行，阻止其他事务获得相同数据集的行排他锁。用`SELECT ... IN SHARE MODE`可以获取行共享锁。
    * 行排他锁：允许一个事务更新数据，阻止其他事务获得相同数据集的行共享锁和行排他锁。用`SELECT ... FOR UPDATE`可以获取行排他锁。

### 索引和主键
* MyISAM：允许没有任何索引和主键的表存在，所有索引都是非聚集索引。
* InnoDB：如果没有设定主键或者非空唯一索引，就会自动生成一个用户不可见的主键，主索引是聚集索引，其他索引是非聚集索引。

### 外键
MyISAM不支持外键，而InnoDB支持外键。

## InnoDB的间隙锁（Next-Key锁）
* 概念：当检索范围数据并请求共享或排他锁时，InnoDB会给符合条件的数据的索引项加锁，间隙是指键值在条件范围内但并不存在的记录，InnoDB也会对这些记录加锁。
* 举例：假如item表中有10条记录，其id的值分别是1到10，查询语句`SELECT * FROM item WHERE id > 9 FOR UPDATE`是一个范围条件的检索，InnoDB不仅会对符合条件的id值为10的记录加锁，也会对id大于10（这些记录并不存在）的“间隙”加锁。
* 注意事项：InnoDB使用间隙锁的目的是防止幻读，以满足相关隔离级别的要求，但会阻塞符合条件范围内键值的并发插入，这往往会造成严重的锁等待。

## MySQL中char、varchar和text的区别

### char(n)
* 存储定长字符串，可以指定默认值，索引效率非常高，必须在括号里定义长度n，超过会被截断，n的最大值是255。
* n也是存储空间的实际长度，不管实际字符串有多长，都会占用n个字符的空间，后面会用空格填充，如果原数据末尾就存在空格，检索取出时会丢失。

### varchar(n)
* 存储变长字符串，可以指定默认值，存储效率没有char(n)高，可以在括号里定义长度n，超过会被截断，所以实际可以保存的最大字符串长度是n-1，因为在字符串被截断时，会留一个空间保存字符串结束的标记。
* 保存数据的时候不进行空格自动填充，而且如果数据存在空格，保存和检索时尾部的空格仍会保留。
* varchar(n)可以指定的长度上限是65535字节，但实际情况会有1-3个字节存储字符串的长度信息，所以实际可以保存的字符串的最大长度为65532字节。

### text 
* text是用来存储较长字符串的结构，其存储原理与varchar(n)相同，效率也相似。
* text与varchar(n)的区别主要是：text不能限定最大长度n，也不能指定默认值，而且使用外部存储来存储字符长度，不占用字符串空间，最大支持字符串长度为65535个字节。

## 慢查询日志
* 用来记录响应时间超过阀值的查询操作，可以用来找出有问题的SQL语句。
* 相关参数：
    * `slow_query_log`：是否开启慢查询日志。
    * `long_query_time`：慢查询阀值，当查询时间多于设定的阀值时，记录日志。
    * `log_queries_not_using_indexes`：未使用索引的查询也被记录到慢查询日志中。
    * `log_output`：日志存储方式，可以文件形式存储，也可以存入数据库，还可以两者同时启用。

## explain命令
* 用于查看执行查询效果，展示了MySQL如何使用索引来处理select语句以及连接表，可以帮助选择更好的索引和写出更优化的查询语句。
* 使用方法：在select语句前加上explain，如explain select * from user;。
* 结果中每一列的解释：
    * id：表示select查询序列号，代表SQL语句执行的顺序。
    * select_type：表示查询类型，包括simple、primary、union、dependent union和union result。
    * table：表示该行数据是关于哪张表的。
    * type：表示连接使用了什么类型，从好到坏依次为const、eq_reg、ref、range、index和ALL。
    * possible_keys：表示可能应用在这张表中的索引，如果为空则表示没有可用的索引。
    * key：表示查询中实际使用的索引，如果为空则表示没有使用索引。
    * key_len：表示使用的索引的长度，在不损失精确性的情况下，长度越短越好。
    * ref：表示索引的哪一列被使用了，如果可能的话是一个常数。
    * rows：表示返回查询结果必须检查的数据行数，数值越大越不好，说明没有用好索引。
    * extra：表示MySQL如何解析查询的额外信息。